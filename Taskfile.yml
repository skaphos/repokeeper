version: "3"

tasks:
  default:
    desc: List available tasks
    cmds:
      - go tool task --list

  list:
    desc: List available tasks
    cmds:
      - go tool task --list

  all:
    desc: Build the local binary
    deps:
      - build

  build:
    desc: Build the repokeeper binary for the local OS/ARCH
    cmds:
      - go build -o repokeeper .

  install:
    desc: Install repokeeper binary to $GOPATH/bin
    cmds:
      - go install .

  uninstall:
    desc: Uninstall repokeeper binary from $GOPATH/bin
    cmds:
      - go clean -i github.com/skaphos/repokeeper

  build-ci:
    desc: Build all configured platform binaries (CI-style snapshot build)
    cmds:
      - go tool goreleaser build --snapshot --clean

  test:
    desc: Run test suite
    cmds:
      - go tool ginkgo ./...

  test-cover:
    desc: Run tests with coverage output
    cmds:
      - go test -coverprofile=coverage.out ./...

  test-cover-check:
    desc: Run tests with coverage and enforce per-package thresholds
    cmds:
      - go test -coverprofile=coverage.out ./...
      - ./scripts/check-coverage.sh coverage.out

  coverage-report:
    desc: Run coverage and print low-coverage packages/functions
    cmds:
      - go test -coverprofile=coverage.out ./...
      - ./scripts/coverage-report.sh coverage.out

  test-integration:
    desc: Run integration-tagged tests
    cmds:
      - go test -v -tags integration ./...

  lint:
    desc: Run linters
    cmds:
      - go tool golangci-lint run ./...

  fmt:
    desc: Format code
    cmds:
      - go tool goimports -w .
      - go fmt ./...

  staticcheck:
    desc: Run staticcheck directly
    cmds:
      - go tool staticcheck ./...

  vuln:
    desc: Run vulnerability scan
    cmds:
      - go tool govulncheck ./...

  perf-bench:
    desc: Run benchmarks and append a timestamped history record
    cmds:
      - go run ./scripts/perf -history perf/history.jsonl -raw-dir perf/runs -packages ./internal/engine -bench . -benchtime 1x -count 5

  version-next:
    desc: Show next semantic version from git history (svu)
    cmds:
      - go tool svu next

  clean:
    desc: Remove build artifacts and clear Go build outputs
    cmds:
      - go clean ./...
      - go clean -testcache
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue; Remove-Item -Force repokeeper.exe,repokeeper,coverage.out -ErrorAction SilentlyContinue"{{else}}rm -rf dist repokeeper coverage.out{{end}}'

  ci:
    desc: Run standard CI workflow locally
    deps:
      - lint
      - test
      - test-integration
      - staticcheck
      - vuln
      - build-ci
